name: python-algorithmen-datenstrukturen

services:
  api-dev:
    profiles: ["live"]
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    working_dir: /workspace/apps/api
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      - ./:/workspace
    ports:
      - "8000:8000"

  web-dev:
    profiles: ["live"]
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    working_dir: /workspace/apps/web
    command: npm run dev -- --host 0.0.0.0 --port 5173
    environment:
      VITE_USER_ROLE: admin
      VITE_USER_ID: docker-admin
    volumes:
      - ./:/workspace
      - web_node_modules:/workspace/apps/web/node_modules
    ports:
      - "5173:5173"
    depends_on:
      - api-dev

  docs-dod:
    profiles: ["test"]
    image: python:3.11-slim
    working_dir: /workspace
    volumes:
      - ./:/workspace
    command: python3 apps/tools/check_docs_dod.py

  api-tests:
    profiles: ["test"]
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    working_dir: /workspace/apps/api
    command: python -m unittest discover -s tests -p "test_*.py"
    volumes:
      - ./:/workspace

  api-security:
    profiles: ["test"]
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    working_dir: /workspace/apps/api
    command: >
      sh -c "pip install --no-cache-dir pip-audit &&
      pip-audit -r requirements.txt --progress-spinner off
      --ignore-vuln CVE-2025-54121
      --ignore-vuln CVE-2025-62727"
    volumes:
      - ./:/workspace

  web-tests:
    profiles: ["test"]
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    working_dir: /workspace/apps/web
    command: sh -c "npm run test && npm run build && npm audit --audit-level=high"
    volumes:
      - ./:/workspace
      - web_node_modules:/workspace/apps/web/node_modules

volumes:
  web_node_modules: